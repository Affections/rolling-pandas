'use client';

import { useRef, useEffect } from 'react';
import './HowWeWorkSection.css';
import PrimaryButton from '@/components/PrimaryButton/PrimaryButton';

const PARALLAX_BG = 24;
const PARALLAX_BOX_1 = 6;
const PARALLAX_BOX_2 = 8;
const PARALLAX_BOX_3 = 10;
const PARALLAX_BOX_4 = 12;
const SMOOTH = 0.06;

type MouseRef = { current: { x: number; y: number } };

const Box1Icon = () => (
  <svg width="36" height="26" viewBox="0 0 36 26" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden>
    <path d="M7.66667 1H6.33333C5.62609 1 4.94781 1.28095 4.44772 1.78105C3.94762 2.28115 3.66667 2.95942 3.66667 3.66667V10.3333C3.66667 11.0406 3.38572 11.7189 2.88562 12.219C2.38552 12.719 1.70724 13 1 13C1.70724 13 2.38552 13.281 2.88562 13.781C3.38572 14.2811 3.66667 14.9594 3.66667 15.6667V22.3333C3.66667 23.8 4.86667 25 6.33333 25H7.66667" stroke="#8E6DF0" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
    <path d="M16.0105 6.988C15.8025 6.988 15.6585 6.944 15.5785 6.856C15.5065 6.76 15.4945 6.636 15.5425 6.484C15.5825 6.34 15.6705 6.224 15.8065 6.136C15.9425 6.04 16.1225 5.992 16.3465 5.992L18.2065 5.968C18.5505 5.96 18.8425 5.932 19.0825 5.884C19.3225 5.828 19.5425 5.74 19.7425 5.62C19.9505 5.492 20.1585 5.328 20.3665 5.128C20.5105 5.008 20.6385 4.924 20.7505 4.876C20.8625 4.82 20.9745 4.792 21.0865 4.792C21.2785 4.792 21.4105 4.84 21.4825 4.936C21.5625 5.024 21.5745 5.168 21.5185 5.368L17.5705 20.2C17.4985 20.416 17.4905 20.592 17.5465 20.728C17.6105 20.856 17.7785 20.936 18.0505 20.968L19.6465 21.16C19.7825 21.184 19.8825 21.232 19.9465 21.304C20.0105 21.368 20.0385 21.448 20.0305 21.544C20.0225 21.696 19.9585 21.812 19.8385 21.892C19.7185 21.964 19.5665 22 19.3825 22H12.0625C11.8785 22 11.7465 21.964 11.6665 21.892C11.5785 21.82 11.5385 21.72 11.5465 21.592C11.5625 21.472 11.6185 21.372 11.7145 21.292C11.8185 21.212 11.9545 21.16 12.1225 21.136L13.9825 20.944C14.2065 20.92 14.3985 20.844 14.5585 20.716C14.7265 20.58 14.8465 20.4 14.9185 20.176L18.1705 7.828C18.2665 7.508 18.2785 7.292 18.2065 7.18C18.1425 7.068 17.9825 7.012 17.7265 7.012L16.0105 6.988Z" fill="#8E6DF0"/>
    <path d="M27.6665 25H28.9998C29.7071 25 30.3854 24.719 30.8855 24.219C31.3856 23.7189 31.6665 23.0406 31.6665 22.3333V15.6667C31.6665 14.2 32.8665 13 34.3332 13C33.6259 13 32.9476 12.719 32.4476 12.219C31.9475 11.7189 31.6665 11.0406 31.6665 10.3333V3.66667C31.6665 2.95942 31.3856 2.28115 30.8855 1.78105C30.3854 1.28095 29.7071 1 28.9998 1H27.6665" stroke="#8E6DF0" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
  </svg>
);

const Box2Icon = () => (
  <svg width="38" height="26" viewBox="0 0 38 26" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden>
    <path d="M7.66667 1H6.33333C5.62609 1 4.94781 1.28095 4.44771 1.78105C3.94762 2.28115 3.66667 2.95942 3.66667 3.66667V10.3333C3.66667 11.0406 3.38572 11.7189 2.88562 12.219C2.38552 12.719 1.70724 13 1 13C1.70724 13 2.38552 13.281 2.88562 13.781C3.38572 14.2811 3.66667 14.9594 3.66667 15.6667V22.3333C3.66667 23.8 4.86667 25 6.33333 25H7.66667" stroke="#8E6DF0" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
    <path d="M13.7583 18.628L13.5543 18.112L16.5783 16.276C17.9383 15.468 19.0703 14.688 19.9743 13.936C20.8783 13.184 21.5983 12.412 22.1343 11.62C22.6703 10.828 23.0623 9.972 23.3103 9.052C23.5423 8.18 23.6223 7.448 23.5503 6.856C23.4783 6.264 23.2743 5.816 22.9383 5.512C22.6103 5.208 22.1623 5.056 21.5943 5.056C20.9863 5.056 20.4503 5.176 19.9863 5.416C19.5223 5.648 19.1383 5.964 18.8343 6.364C18.5303 6.764 18.3103 7.208 18.1743 7.696L17.8863 8.764C17.7583 9.244 17.5343 9.616 17.2143 9.88C16.8943 10.144 16.5303 10.276 16.1223 10.276C15.7063 10.276 15.4143 10.14 15.2463 9.868C15.0783 9.588 15.0663 9.192 15.2103 8.68C15.4183 7.944 15.8263 7.244 16.4343 6.58C17.0503 5.916 17.8383 5.372 18.7983 4.948C19.7663 4.524 20.8743 4.312 22.1223 4.312C23.2743 4.312 24.1863 4.524 24.8583 4.948C25.5303 5.364 25.9663 5.94 26.1663 6.676C26.3743 7.404 26.3503 8.236 26.0943 9.172C25.9343 9.748 25.6743 10.308 25.3143 10.852C24.9543 11.396 24.4623 11.948 23.8383 12.508C23.2143 13.068 22.4223 13.664 21.4623 14.296C20.5103 14.928 19.3623 15.62 18.0183 16.372L13.7583 18.628ZM11.7543 20.2C11.9543 19.464 12.4023 18.844 13.0983 18.34C13.7943 17.828 14.6663 17.572 15.7143 17.572C16.2183 17.572 16.7023 17.66 17.1663 17.836C17.6383 18.004 18.0903 18.2 18.5223 18.424C18.9623 18.648 19.3903 18.848 19.8063 19.024C20.2303 19.192 20.6503 19.276 21.0663 19.276C21.6183 19.276 22.0823 19.144 22.4583 18.88C22.8343 18.608 23.1983 18.164 23.5503 17.548C23.6383 17.412 23.7343 17.316 23.8383 17.26C23.9423 17.204 24.0463 17.184 24.1503 17.2C24.2943 17.208 24.3863 17.264 24.4263 17.368C24.4663 17.472 24.4383 17.632 24.3423 17.848C23.9823 18.776 23.5823 19.524 23.1423 20.092C22.7103 20.652 22.2383 21.06 21.7263 21.316C21.2223 21.564 20.6703 21.688 20.0703 21.688C19.5583 21.688 19.1143 21.612 18.7383 21.46C18.3703 21.316 18.0503 21.076 17.7783 20.74C17.5143 20.396 17.2703 19.944 17.0463 19.384C16.7903 19.024 16.5663 18.764 16.3743 18.604C16.1903 18.444 15.9663 18.364 15.7023 18.364C15.4383 18.364 15.2023 18.488 14.9943 18.736C14.7943 18.984 14.6103 19.376 14.4423 19.912C14.2983 20.352 14.1303 20.7 13.9383 20.956C13.7463 21.212 13.5343 21.392 13.3023 21.496C13.0783 21.608 12.8223 21.664 12.5343 21.664C12.1903 21.664 11.9423 21.54 11.7903 21.292C11.6383 21.036 11.6263 20.672 11.7543 20.2Z" fill="#8E6DF0"/>
    <path d="M30.3062 25H31.6395C32.3467 25 33.025 24.719 33.5251 24.219C34.0252 23.7189 34.3062 23.0406 34.3062 22.3333V15.6667C34.3062 14.2 35.5062 13 36.9728 13C36.2656 13 35.5873 12.719 35.0872 12.219C34.5871 11.7189 34.3062 11.0406 34.3062 10.3333V3.66667C34.3062 2.95942 34.0252 2.28115 33.5251 1.78105C33.025 1.28095 32.3467 1 31.6395 1H30.3062" stroke="#8E6DF0" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
  </svg>
);

const Box3Icon = () => (
  <svg width="39" height="26" viewBox="0 0 39 26" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden>
    <path d="M7.66667 1H6.33333C5.62609 1 4.94781 1.28095 4.44771 1.78105C3.94762 2.28115 3.66667 2.95942 3.66667 3.66667V10.3333C3.66667 11.0406 3.38572 11.7189 2.88562 12.219C2.38552 12.719 1.70724 13 1 13C1.70724 13 2.38552 13.281 2.88562 13.781C3.38572 14.2811 3.66667 14.9594 3.66667 15.6667V22.3333C3.66667 23.8 4.86667 25 6.33333 25H7.66667" stroke="#8E6DF0" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
    <path d="M17.7531 12.382V12.082C17.8411 12.058 17.9491 12.042 18.0771 12.034C18.2131 12.018 18.3531 12.006 18.4971 11.998C18.6491 11.982 18.7771 11.974 18.8811 11.974C20.0491 11.966 20.9931 12.146 21.7131 12.514C22.4411 12.874 22.9251 13.406 23.1651 14.11C23.4131 14.806 23.4011 15.646 23.1291 16.63C22.8571 17.614 22.3771 18.474 21.6891 19.21C21.0011 19.946 20.1651 20.522 19.1811 20.938C18.1971 21.346 17.1171 21.55 15.9411 21.55C14.8371 21.55 13.9491 21.386 13.2771 21.058C12.6051 20.73 12.1451 20.294 11.8971 19.75C11.6491 19.206 11.6011 18.606 11.7531 17.95C11.8811 17.422 12.1091 17.014 12.4371 16.726C12.7651 16.43 13.1251 16.282 13.5171 16.282C13.9491 16.282 14.2411 16.418 14.3931 16.69C14.5531 16.954 14.5731 17.298 14.4531 17.722L14.1771 18.67C14.0011 19.342 14.0891 19.866 14.4411 20.242C14.8011 20.618 15.4091 20.806 16.2651 20.806C16.8651 20.806 17.4371 20.662 17.9811 20.374C18.5251 20.078 19.0091 19.65 19.4331 19.09C19.8571 18.522 20.1811 17.826 20.4051 17.002C20.7651 15.61 20.7291 14.582 20.2971 13.918C19.8651 13.254 19.0331 12.922 17.8011 12.922H17.0331C16.8571 12.922 16.7291 12.882 16.6491 12.802C16.5691 12.722 16.5491 12.61 16.5891 12.466C16.6291 12.338 16.7051 12.218 16.8171 12.106C16.9371 11.994 17.0891 11.874 17.2731 11.746L24.2451 5.86601L24.0771 6.57401H17.4291C17.1731 6.57401 16.9651 6.62201 16.8051 6.71801C16.6451 6.81401 16.5011 6.96601 16.3731 7.17401L15.7011 8.41001C15.6291 8.53801 15.5331 8.64601 15.4131 8.73401C15.3011 8.81401 15.1731 8.85401 15.0291 8.85401C14.8771 8.84601 14.7651 8.79401 14.6931 8.69801C14.6291 8.60201 14.6411 8.45801 14.7291 8.26601L15.9651 5.14601C16.0611 4.92201 16.2011 4.75001 16.3851 4.63001C16.5691 4.51001 16.8051 4.45001 17.0931 4.45001H25.8651C26.0571 4.45001 26.1931 4.49801 26.2731 4.59401C26.3531 4.68201 26.3731 4.79801 26.3331 4.94201C26.2931 5.07001 26.2011 5.19801 26.0571 5.32601C25.9131 5.45401 25.7131 5.60601 25.4571 5.78201L17.7531 12.382Z" fill="#8E6DF0"/>
    <path d="M30.3535 25H31.6868C32.3941 25 33.0724 24.719 33.5725 24.219C34.0726 23.7189 34.3535 23.0406 34.3535 22.3333V15.6667C34.3535 14.2 35.5535 13 37.0202 13C36.3129 13 35.6347 12.719 35.1346 12.219C34.6345 11.7189 34.3535 11.0406 34.3535 10.3333V3.66667C34.3535 2.95942 34.0726 2.28115 33.5725 1.78105C33.0724 1.28095 32.3941 1 31.6868 1H30.3535" stroke="#8E6DF0" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
  </svg>
);

const Box4Icon = () => (
  <svg width="36" height="26" viewBox="0 0 36 26" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden>
    <path d="M7.66667 1H6.33333C5.62609 1 4.94781 1.28095 4.44771 1.78105C3.94762 2.28115 3.66667 2.95942 3.66667 3.66667V10.3333C3.66667 11.0406 3.38572 11.7189 2.88562 12.219C2.38552 12.719 1.70724 13 1 13C1.70724 13 2.38552 13.281 2.88562 13.781C3.38572 14.2811 3.66667 14.9594 3.66667 15.6667V22.3333C3.66667 23.8 4.86667 25 6.33333 25H7.66667" stroke="#8E6DF0" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
    <path d="M20.1055 12.616C20.1455 12.464 20.2095 12.332 20.2975 12.22C20.3935 12.108 20.4975 12.012 20.6095 11.932L22.4335 10.384C22.5695 10.288 22.6815 10.224 22.7695 10.192C22.8575 10.152 22.9455 10.132 23.0335 10.132C23.1215 10.132 23.1855 10.164 23.2255 10.228C23.2655 10.284 23.2655 10.376 23.2255 10.504L20.8015 19.78C20.7375 20.004 20.7455 20.176 20.8255 20.296C20.9135 20.416 21.0695 20.492 21.2935 20.524L22.3255 20.716C22.4695 20.756 22.5775 20.812 22.6495 20.884C22.7215 20.948 22.7375 21.04 22.6975 21.16C22.6575 21.288 22.5775 21.392 22.4575 21.472C22.3375 21.544 22.1775 21.58 21.9775 21.58H15.8815C15.6815 21.58 15.5415 21.544 15.4615 21.472C15.3895 21.392 15.3735 21.288 15.4135 21.16C15.4535 21.04 15.5295 20.944 15.6415 20.872C15.7615 20.792 15.9095 20.74 16.0855 20.716L17.2975 20.524C17.5375 20.492 17.7335 20.416 17.8855 20.296C18.0455 20.168 18.1615 19.988 18.2335 19.756L20.1055 12.616ZM19.4095 9.70001C19.7135 9.46001 19.9695 9.22801 20.1775 9.00401C20.3855 8.78001 20.5215 8.54001 20.5855 8.28401C20.6495 8.08401 20.6655 7.89601 20.6335 7.72001C20.6095 7.53601 20.5735 7.35601 20.5255 7.18001C20.4775 7.00401 20.4415 6.82401 20.4175 6.64001C20.4015 6.44801 20.4255 6.24001 20.4895 6.01601C20.6175 5.55201 20.8775 5.17201 21.2695 4.87601C21.6695 4.57201 22.1575 4.42001 22.7335 4.42001C23.2215 4.42001 23.5815 4.55601 23.8135 4.82801C24.0455 5.10001 24.1015 5.48001 23.9815 5.96801C23.9015 6.28001 23.7655 6.59201 23.5735 6.90401C23.3895 7.21601 23.1295 7.54401 22.7935 7.88801C22.4575 8.23201 22.0215 8.61601 21.4855 9.04001L12.6655 16.852L12.6295 16.468H23.7295C23.8975 16.468 24.0215 16.5 24.1015 16.564C24.1815 16.628 24.2015 16.732 24.1615 16.876C24.1135 17.028 24.0295 17.144 23.9095 17.224C23.7975 17.304 23.6415 17.344 23.4415 17.344L12.1615 17.332C11.9615 17.332 11.8215 17.284 11.7415 17.188C11.6615 17.092 11.6455 16.968 11.6935 16.816C11.7255 16.72 11.7895 16.616 11.8855 16.504C11.9815 16.392 12.1335 16.268 12.3415 16.132L19.4095 9.70001Z" fill="#8E6DF0"/>
    <path d="M28.1816 25H29.515C30.2222 25 30.9005 24.719 31.4006 24.219C31.9007 23.7189 32.1816 23.0406 32.1816 22.3333V15.6667C32.1816 14.2 33.3816 13 34.8483 13C34.1411 13 33.4628 12.719 32.9627 12.219C32.4626 11.7189 32.1816 11.0406 32.1816 10.3333V3.66667C32.1816 2.95942 31.9007 2.28115 31.4006 1.78105C30.9005 1.28095 30.2222 1 29.515 1H28.1816" stroke="#8E6DF0" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
  </svg>
);

type HowWeWorkSectionProps = { mouseRef: MouseRef };

export default function HowWeWorkSection({ mouseRef }: HowWeWorkSectionProps) {
  const bgLayerRef = useRef<HTMLDivElement>(null);
  const box1Ref = useRef<HTMLDivElement>(null);
  const box2Ref = useRef<HTMLDivElement>(null);
  const box3Ref = useRef<HTMLDivElement>(null);
  const box4Ref = useRef<HTMLDivElement>(null);
  const currentBg = useRef({ x: 0, y: 0 });
  const currentBoxes = useRef([
    { x: 0, y: 0 },
    { x: 0, y: 0 },
    { x: 0, y: 0 },
    { x: 0, y: 0 },
  ]);
  const rafRef = useRef<number>(0);

  useEffect(() => {
    const bg = bgLayerRef.current;
    const boxes = [box1Ref.current, box2Ref.current, box3Ref.current, box4Ref.current];
    const factors = [PARALLAX_BOX_1, PARALLAX_BOX_2, PARALLAX_BOX_3, PARALLAX_BOX_4];
    if (!bg) return;

    const tick = () => {
      const { x: tx, y: ty } = mouseRef.current;
      const t = performance.now() * 0.001;

      currentBg.current.x += (tx * PARALLAX_BG - currentBg.current.x) * SMOOTH;
      currentBg.current.y += (ty * PARALLAX_BG - currentBg.current.y) * SMOOTH;
      bg.style.transform = `translate(${currentBg.current.x}px, ${currentBg.current.y}px)`;

      boxes.forEach((box, i) => {
        if (!box) return;
        const c = currentBoxes.current[i];
        const f = factors[i];
        c.x += (tx * f - c.x) * SMOOTH;
        c.y += (ty * f - c.y) * SMOOTH;
        const floatY = Math.sin(t + i * 0.5) * 2;
        const floatX = Math.cos(t * 0.7 + i * 0.3) * 1;
        box.style.transform = `translate(${c.x + floatX}px, ${c.y + floatY}px)`;
      });

      rafRef.current = requestAnimationFrame(tick);
    };

    rafRef.current = requestAnimationFrame(tick);
    return () => cancelAnimationFrame(rafRef.current);
  }, [mouseRef]);

  return (
    <section className="how-we-work">
      <div className="how-we-work__bg-wrap">
        <div ref={bgLayerRef} className="how-we-work__bg-layer">
          <img
            src="/how-we-work-bg.png"
            alt=""
            className="how-we-work__bg-img"
          />
        </div>
      </div>
      <div className="how-we-work__content">
        <h2 className="how-we-work__title">
          How we <span className="how-we-work__title-accent">work</span>
        </h2>
        <p className="how-we-work__intro">
          We ship fast, communicate clearly, and focus on impact. No surprises, no hidden hours.
        </p>

        <div className="how-we-work__boxes">
        <div ref={box1Ref} className="how-we-work__box how-we-work__box--1">
          <div className="how-we-work__box-icon">
            <Box1Icon />
          </div>
          <h3 className="how-we-work__box-title">Trial week (optional)</h3>
          <p className="how-we-work__box-desc">
            Start small. We prove speed, quality, and communication before anything long-term.
          </p>
        </div>

        <div ref={box2Ref} className="how-we-work__box how-we-work__box--2">
          <div className="how-we-work__box-icon">
            <Box2Icon />
          </div>
          <h3 className="how-we-work__box-title">Weekly priorities</h3>
          <p className="how-we-work__box-desc">
            We align on scope and impact every week â€” so the backlog stays under control.
          </p>
        </div>

        <div ref={box3Ref} className="how-we-work__box how-we-work__box--3">
          <div className="how-we-work__box-icon">
            <Box3Icon />
          </div>
          <h3 className="how-we-work__box-title">Daily shipping</h3>
          <p className="how-we-work__box-desc">
            Fast iteration with QA and clean releases. No drama, no regressions.
          </p>
        </div>

        <div ref={box4Ref} className="how-we-work__box how-we-work__box--4">
          <div className="how-we-work__box-icon">
            <Box4Icon />
          </div>
          <h3 className="how-we-work__box-title">Reporting & optimization</h3>
          <p className="how-we-work__box-desc">
            Clear reporting on what was shipped, what&apos;s next, and what moved the needle.
          </p>
        </div>
        </div>

        <div className="how-we-work__cta">
          <p className="how-we-work__cta-text">
            Want to see what we&apos;d <span className="how-we-work__cta-accent">improve</span> first?
          </p>
          <PrimaryButton className="how-we-work__cta-btn">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" className="how-we-work__cta-icon" aria-hidden>
              <path d="M8.33333 3.41663L10 4.99996" stroke="currentColor" strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round"/>
              <path d="M15.7503 6.66667L18.167 6" stroke="currentColor" strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round"/>
              <path d="M14.9997 10L16.583 11.6667" stroke="currentColor" strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round"/>
              <path d="M14 1.83337L13.3333 4.25004" stroke="currentColor" strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round"/>
              <path d="M12.469 8.07496C12.5013 7.99884 12.5101 7.9148 12.4943 7.83362C12.4786 7.75244 12.4389 7.67783 12.3804 7.61935C12.3219 7.56088 12.2473 7.52121 12.1661 7.50543C12.085 7.48965 12.0009 7.49848 11.9248 7.5308L2.75813 11.2808C2.67654 11.3143 2.60768 11.3728 2.56145 11.4478C2.51522 11.5229 2.49401 11.6108 2.50086 11.6987C2.50772 11.7866 2.54229 11.8701 2.5996 11.9371C2.65691 12.0041 2.73401 12.0512 2.81979 12.0716L6.44396 12.9391C6.59357 12.9749 6.73037 13.0513 6.83921 13.16C6.94805 13.2687 7.02469 13.4054 7.06063 13.555L7.92729 17.18C7.94749 17.266 7.99454 17.3435 8.06165 17.401C8.12876 17.4586 8.21244 17.4933 8.30058 17.5002C8.38873 17.5071 8.47678 17.4857 8.55199 17.4392C8.6272 17.3927 8.68568 17.3235 8.71896 17.2416L12.469 8.07496Z" stroke="currentColor" strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round"/>
            </svg>
            GET A FREE STORE AUDIT VIDEO
          </PrimaryButton>
        </div>
      </div>
    </section>
  );
}
